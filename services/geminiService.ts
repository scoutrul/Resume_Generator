import { GoogleGenAI, Type } from "@google/genai";
import { GenerationOutput, CoverLetterLength } from "../types";

const API_KEY = process.env.API_KEY;

if (!API_KEY) {
  throw new Error("API_KEY environment variable not set");
}

const ai = new GoogleGenAI({ apiKey: API_KEY });

const generationSchema = {
  type: Type.OBJECT,
  properties: {
    resume: {
      type: Type.STRING,
      description: "Полное, адаптированное резюме в формате Markdown. Оно должно быть подогнано под описание вакансии, выделяя релевантный опыт и навыки из профиля кандидата.",
    },
    coverLetter: {
      type: Type.STRING,
      description: "Полное, персонализированное сопроводительное письмо в формате Markdown. Оно должно создавать убедительное повествование, связывающее достижения кандидата с потребностями работодателя.",
    },
  },
  required: ["resume", "coverLetter"],
};

const getCoverLetterInstruction = (length: CoverLetterLength): string => {
  switch (length) {
    case 'short':
      return "Напиши краткое, профессиональное и воодушевленное сопроводительное письмо (около 2-3 абзацев).";
    case 'medium':
      return "Напиши профессиональное и воодушевленное сопроводительное письмо средней длины (около 3-4 абзацев).";
    case 'long':
      return "Напиши развернутое, профессиональное и воодушевленное сопроводительное письмо (около 4-5 абзацев), подробно раскрывающее сильные стороны кандидата.";
    default:
      return "Напиши профессиональное и воодушевленное сопроводительное письмо средней длины (около 3-4 абзацев).";
  }
}

const getPrompt = (vacancy: string, profile: string, coverLetterLength: CoverLetterLength): string => {
  const coverLetterInstruction = getCoverLetterInstruction(coverLetterLength);
  return `
    **Роль:** Ты — эксперт-карьерный консультант и профессиональный составитель резюме, работающий как интеллектуальный 'Генератор резюме на базе LLM'.

    **Контекст:** Тебе будет предоставлена два блока информации: 'Профиль кандидата' в формате JSON и 'Вакансия' в виде обычного текста.

    **Основная цель:** Сгенерировать персонализированное, адаптированное резюме и убедительное сопроводительное письмо, которые максимизируют шансы кандидата на получение приглашения на собеседование. Проанализируй вакансию, чтобы понять ее ключевые требования, технологический стек, обязанности и культуру компании. Затем сопоставь это с профилем кандидата, чтобы выделить наиболее релевантные навыки, опыт и достижения. Весь результат должен быть на русском языке.

    Проанализируй предоставленные Описание вакансии и резюме кандидата с позиций всех специалистов. Вот структура анализа:

    **1. RECRUITER ANALYSIS** (Формальное соответствие)
    - Соответствие позиции и грейда
    - Локация и формат работы
    - Зарплатные ожидания vs рынок
    - Общее впечатление от структуры резюме
    - Красные флаги в карьере

    **2. TECHNICAL RECRUITER ANALYSIS** (Техническое соответствие)
    - Соответствие стеку технологий вакансии "{{ $json.name[0] }}"
    - Опыт в domain-области (финтех)
    - Уровень английского (если требуется)
    - Культурный фит

    **3. TEAM LEAD ANALYSIS** (Техническая глубина)
    - Глубина знаний Vue и экосистемы
    - Опыт решения сложных задач
    - Соответствие грейду (Middle/Senior)
    - Архитектурные навыки
    - Опыт код-ревью и менторства

    **4. TECHNICAL SPECIALIST ANALYSIS** (Конкретные навыки)
    - Конкретные технологии из вакансии
    - Качество кода и best practices
    - Опыт с highload проектами
    - Навыки CI/CD, Docker

    **5. PRODUCT MANAGER ANALYSIS** (Продуктовое мышление)
    - Понимание финтеха и бизнес-ценности
    - Опыт работы в Agile/Scrum
    - Взаимодействие с командами
    - UX/UI понимание

    **6. HRBP ANALYSIS** (Стратегическое соответствие)
    - Соответствие корпоративной культуре
    - Лидерский потенциал
    - Долгосрочные цели
    - Совместимость с ценностями компании

    **7. CANDIDATE SELF-ANALYSIS** (Мотивация)
    - Интерес к компании и продукту
    - Соответствие карьерным целям
    - Готовность к требованиям
    - Личные приоритеты

    **8. CAREER ADVOCATE SYNTHESIS** (Финальный вердикт)
    - Сводная оценка соответствия
    - Сильные стороны для акцента
    - Зоны риска и как их закрыть
    - Рекомендации по подготовке
    - Финальный вердикт и стратегия

    **Инструкции:**
    Напиши сопроводительное письмо для отклика на вакансию, используя следующий framework:

    **КОНТЕКСТ:**
    - Вакансия: [вставить текст вакансии]
    - Резюме кандидата: [вставить ключевые пункты резюме]
    - Анализ соответствия: [вставить вердикт Career Advocate]

    **ТРЕБОВАНИЯ К СТИЛЮ:**
    - Объем: 100-150 слов (кратко и по делу)
    - Тон: [адаптировать под тон вакансии - дружеский/профессиональный/энергичный]
    - Обращение: [использовать "вы" или "ты" в зависимости от стиля вакансии]
    - Фокус: ценность для компании, а не просто перечень навыков

    **СТРУКТУРА ПИСЬМА:**
    1. **Крючок** (1 предложение) - что зацепило в вакансии
    2. **Основная ценность** (2-3 пункта) - ключевые соответствия из анализа
    3. **Мотивация** (1 предложение) - почему именно эта компания
    4. **Призыв к действию** - предложение обсудить детали

    **ЧТО ПОДЧЕРКНУТЬ (из анализа ролей):**
    - Технические навыки: [главные 2-3 технологии из вакансии]
    - Domain-опыт: [соответствие индустрии компании]  
    - Культурный фит: [ценности компании из вакансии]
    - Сильные стороны: [ключевые преимущества из вердикта]

    **ЧЕГО ИЗБЕГАТЬ:**
    - Шаблонных фраз ("ищу интересные задачи")
    - Пересказа всего резюме
    - Извинений за недостающий опыт
    - Слишком формального тона (если вакансия неформальная)

    Сгенерируй письмо которое звучит как письмо реального человека, а не шаблонный отклик.
    1.  **Сгенерируй адаптированное резюме используя (Финальный вердикт):** Перепиши и пересортируй опыт и навыки кандидата, чтобы они напрямую отвечали требованиям вакансии. Используй сильные глаголы действия и количественно оценивай достижения, где это возможно. Тон должен соответствовать предполагаемой культуре компании. Сконцентрируйся на наиболее релевантных аспектах и преуменьши значение нерелевантных. Отформатируй вывод в чистом, профессиональном Markdown на русском языке.
    2.  **Сгенерируй сопроводительное письмо:** ${coverLetterInstruction} Оно НЕ должно просто повторять резюме. Вместо этого оно должно создавать повествование, которое связывает 2-3 ключевых достижения или проекта кандидата непосредственно с наиболее важными потребностями, выраженными в описании вакансии. Отформатируй вывод в чистом, профессиональном Markdown на русском языке.

    **Профиль кандидата (JSON):**
    \`\`\`json
    ${profile}
    \`\`\`

    **Описание вакансии (Текст):**
    \`\`\`
    ${vacancy}
    \`\`\`
  `;
};


export const generateResumeAndCoverLetter = async (
  vacancy: string,
  profile: string,
  coverLetterLength: CoverLetterLength
): Promise<GenerationOutput> => {

  const prompt = getPrompt(vacancy, profile, coverLetterLength);

  try {
    const response = await ai.models.generateContent({
      model: "gemini-2.5-pro",
      contents: prompt,
      config: {
        responseMimeType: "application/json",
        responseSchema: generationSchema,
        temperature: 0.5,
      },
    });
    
    // Fix: Correctly parse the JSON string from response.text.
    // The previous logic was convoluted and based on the incorrect assumption that the response was already a parsed object.
    const jsonText = response.text.trim();
    try {
      return JSON.parse(jsonText) as GenerationOutput;
    } catch (e) {
      console.error("Failed to parse JSON response:", jsonText);
      throw new Error("Получен некорректный JSON от API.");
    }

  } catch (error) {
    console.error("Error calling Gemini API:", error);
    throw new Error("Не удалось сгенерировать контент с помощью Gemini API.");
  }
};
